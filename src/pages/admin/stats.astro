---
import BaseLayout from "@/layouts/BaseLayout.astro";

const isIndexed = false; // é˜²æ­¢æœç´¢å¼•æ“ç´¢å¼•
const title = "è®¿å®¢ç»Ÿè®¡";
const description = "åšå®¢è®¿å®¢ç»Ÿè®¡æ•°æ®";

// å¯†ç å“ˆå¸Œï¼ˆSHA-256ï¼‰
const PASSWORD_HASH =
  "cde2a9fbf3563f2ce5c1f9793e8823d3a417f38108df6755305a4220e978fd9e";

// Artalk API é…ç½®
const ARTALK_SERVER = "https://comment.cyb1.org";
const SITE_NAME = "nodcaçš„åšå®¢";
---

<BaseLayout title={title} description={description} isIndexed={isIndexed}>
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- å¯†ç éªŒè¯ç•Œé¢ -->
    <div id="login-form" class="max-w-md mx-auto">
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-2xl mb-4">ğŸ”’ ç®¡ç†å‘˜ç™»å½•</h2>
          <p class="text-sm opacity-70 mb-4">è¯·è¾“å…¥å¯†ç å’Œ Artalk ç®¡ç†å‘˜è´¦å·</p>

          <div class="form-control">
            <label class="label">
              <span class="label-text">é¡µé¢å¯†ç </span>
            </label>
            <input
              type="password"
              id="password-input"
              placeholder="è¯·è¾“å…¥é¡µé¢å¯†ç "
              class="input input-bordered w-full"
              autocomplete="off"
            />
          </div>

          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text">Artalk ç”¨æˆ·å</span>
            </label>
            <input
              type="text"
              id="artalk-name-input"
              placeholder="Artalk ç®¡ç†å‘˜ç”¨æˆ·å"
              class="input input-bordered w-full"
              autocomplete="username"
            />
          </div>

          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text">Artalk é‚®ç®±</span>
            </label>
            <input
              type="email"
              id="artalk-email-input"
              placeholder="Artalk ç®¡ç†å‘˜é‚®ç®±"
              class="input input-bordered w-full"
              autocomplete="email"
            />
          </div>

          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text">Artalk å¯†ç </span>
            </label>
            <input
              type="password"
              id="artalk-password-input"
              placeholder="Artalk ç®¡ç†å‘˜å¯†ç "
              class="input input-bordered w-full"
              autocomplete="current-password"
            />
          </div>

          <div id="error-message" class="text-error text-sm mt-2 hidden"></div>

          <div class="card-actions justify-end mt-4">
            <button id="login-btn" class="btn btn-primary">
              ç™»å½•
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ç»Ÿè®¡æ•°æ®ç•Œé¢ -->
    <div id="stats-content" class="hidden">
      <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- æ€»æµè§ˆé‡ -->
        <div class="stats shadow bg-base-200">
          <div class="stat">
            <div class="stat-figure text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
            </div>
            <div class="stat-title">æ€»æµè§ˆé‡</div>
            <div class="stat-value text-primary" id="total-pv">-</div>
            <div class="stat-desc">å…¨ç«™ç´¯è®¡è®¿é—®</div>
          </div>
        </div>

        <!-- æ–‡ç« æ•°é‡ -->
        <div class="stats shadow bg-base-200">
          <div class="stat">
            <div class="stat-figure text-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <div class="stat-title">æ–‡ç« æ•°é‡</div>
            <div class="stat-value text-secondary" id="total-posts">-</div>
            <div class="stat-desc">å·²å‘å¸ƒæ–‡ç« </div>
          </div>
        </div>

        <!-- è¯„è®ºæ•°é‡ -->
        <div class="stats shadow bg-base-200">
          <div class="stat">
            <div class="stat-figure text-accent">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
            </div>
            <div class="stat-title">è¯„è®ºæ•°é‡</div>
            <div class="stat-value text-accent" id="total-comments">-</div>
            <div class="stat-desc">ç”¨æˆ·äº’åŠ¨</div>
          </div>
        </div>
      </div>

      <!-- æ–‡ç« æ’è¡Œæ¦œ -->
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-2xl">ğŸ“Š æ–‡ç« æµè§ˆæ’è¡Œæ¦œ</h2>
            <button id="refresh-btn" class="btn btn-sm btn-ghost">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
              åˆ·æ–°
            </button>
          </div>

          <div id="loading" class="flex justify-center py-8">
            <span class="loading loading-spinner loading-lg"></span>
          </div>

          <div id="stats-table" class="hidden overflow-x-auto">
            <table class="table table-zebra w-full">
              <thead>
                <tr>
                  <th class="w-16">æ’å</th>
                  <th>æ–‡ç« æ ‡é¢˜</th>
                  <th class="w-24 text-right">æµè§ˆé‡</th>
                  <th class="w-24 text-right">è¯„è®º</th>
                </tr>
              </thead>
              <tbody id="stats-tbody">
                <!-- æ•°æ®å°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
              </tbody>
            </table>
          </div>

          <div id="error-container" class="hidden">
            <div class="alert alert-error">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="error-text">åŠ è½½æ•°æ®å¤±è´¥</span>
            </div>
          </div>
        </div>
      </div>

      <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
      <div class="mt-6 text-center">
        <button id="logout-btn" class="btn btn-ghost btn-sm">
          é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  </div>

  <script define:vars={{ PASSWORD_HASH, ARTALK_SERVER, SITE_NAME }}>
    // å¯†ç éªŒè¯ç›¸å…³
    const AUTH_KEY = 'blog_admin_auth';
    const ARTALK_TOKEN_KEY = 'blog_artalk_token';
    const AUTH_EXPIRY = 24 * 60 * 60 * 1000; // 24 å°æ—¶

    // SHA-256 å“ˆå¸Œå‡½æ•°
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    function checkAuth() {
      const authData = localStorage.getItem(AUTH_KEY);
      const tokenData = localStorage.getItem(ARTALK_TOKEN_KEY);

      if (!authData || !tokenData) return false;

      try {
        const { hash, timestamp } = JSON.parse(authData);
        const { token, expiry } = JSON.parse(tokenData);
        const now = Date.now();

        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (now - timestamp > AUTH_EXPIRY || now > expiry) {
          localStorage.removeItem(AUTH_KEY);
          localStorage.removeItem(ARTALK_TOKEN_KEY);
          return false;
        }

        // æ£€æŸ¥å“ˆå¸Œæ˜¯å¦åŒ¹é…
        return hash === PASSWORD_HASH && token;
      } catch (e) {
        localStorage.removeItem(AUTH_KEY);
        localStorage.removeItem(ARTALK_TOKEN_KEY);
        return false;
      }
    }

    // ä¿å­˜ç™»å½•çŠ¶æ€
    function saveAuth(artalkToken, artalkExpiry) {
      const authData = {
        hash: PASSWORD_HASH,
        timestamp: Date.now()
      };
      localStorage.setItem(AUTH_KEY, JSON.stringify(authData));

      const tokenData = {
        token: artalkToken,
        expiry: artalkExpiry
      };
      localStorage.setItem(ARTALK_TOKEN_KEY, JSON.stringify(tokenData));
    }

    // æ¸…é™¤ç™»å½•çŠ¶æ€
    function clearAuth() {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem(ARTALK_TOKEN_KEY);
    }

    // è·å– Artalk Token
    function getArtalkToken() {
      try {
        const tokenData = localStorage.getItem(ARTALK_TOKEN_KEY);
        if (!tokenData) return null;
        const { token } = JSON.parse(tokenData);
        return token;
      } catch (e) {
        return null;
      }
    }

    // æ˜¾ç¤º/éšè—ç•Œé¢
    function showLogin() {
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('stats-content').classList.add('hidden');
    }

    function showStats() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('stats-content').classList.remove('hidden');
      loadStats();
    }

    // Artalk ç®¡ç†å‘˜ç™»å½•
    async function loginArtalk(name, email, password) {
      const response = await fetch(`${ARTALK_SERVER}/api/v2/auth/email/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: name,
          email: email,
          password: password
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.msg || 'ç™»å½•å¤±è´¥');
      }

      const data = await response.json();

      if (!data.token) {
        throw new Error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯');
      }

      return {
        token: data.token,
        expiry: Date.now() + 259200 * 1000 // 3å¤©ï¼Œä¸ Artalk é…ç½®çš„ login_timeout ä¸€è‡´
      };
    }

    // ç™»å½•å¤„ç†
    async function handleLogin() {
      const passwordInput = document.getElementById('password-input');
      const artalkNameInput = document.getElementById('artalk-name-input');
      const artalkEmailInput = document.getElementById('artalk-email-input');
      const artalkPasswordInput = document.getElementById('artalk-password-input');
      const errorMessage = document.getElementById('error-message');
      const loginBtn = document.getElementById('login-btn');

      const password = passwordInput.value.trim();
      const artalkName = artalkNameInput.value.trim();
      const artalkEmail = artalkEmailInput.value.trim();
      const artalkPassword = artalkPasswordInput.value.trim();

      if (!password) {
        errorMessage.textContent = 'è¯·è¾“å…¥é¡µé¢å¯†ç ';
        errorMessage.classList.remove('hidden');
        return;
      }

      if (!artalkName || !artalkEmail || !artalkPassword) {
        errorMessage.textContent = 'è¯·å¡«å†™å®Œæ•´çš„ Artalk ç®¡ç†å‘˜ä¿¡æ¯';
        errorMessage.classList.remove('hidden');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> éªŒè¯ä¸­...';

      try {
        // 1. éªŒè¯é¡µé¢å¯†ç 
        const hash = await sha256(password);
        if (hash !== PASSWORD_HASH) {
          throw new Error('é¡µé¢å¯†ç é”™è¯¯');
        }

        // 2. ç™»å½• Artalk
        const { token, expiry } = await loginArtalk(artalkName, artalkEmail, artalkPassword);

        // 3. ä¿å­˜è®¤è¯ä¿¡æ¯
        saveAuth(token, expiry);
        errorMessage.classList.add('hidden');

        // æ¸…ç©ºå¯†ç è¾“å…¥æ¡†
        passwordInput.value = '';
        artalkPasswordInput.value = '';

        showStats();
      } catch (e) {
        errorMessage.textContent = `ç™»å½•å¤±è´¥: ${e.message}`;
        errorMessage.classList.remove('hidden');
        console.error('ç™»å½•é”™è¯¯:', e);
      } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'ç™»å½•';
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      const loading = document.getElementById('loading');
      const statsTable = document.getElementById('stats-table');
      const errorContainer = document.getElementById('error-container');

      loading.classList.remove('hidden');
      statsTable.classList.add('hidden');
      errorContainer.classList.add('hidden');

      try {
        const token = getArtalkToken();
        if (!token) {
          throw new Error('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œè¯·é‡æ–°ç™»å½•');
        }

        // è·å–é¡µé¢åˆ—è¡¨
        const response = await fetch(`${ARTALK_SERVER}/api/v2/pages?site_name=${encodeURIComponent(SITE_NAME)}&limit=1000`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            clearAuth();
            showLogin();
            throw new Error('è®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
          }
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data.pages) {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }

        const pages = data.pages;

        // ä¸ºæ¯ä¸ªé¡µé¢è·å–è¯„è®ºæ•°
        await Promise.all(pages.map(async (page) => {
          try {
            const commentRes = await fetch(
              `${ARTALK_SERVER}/api/v2/comments?site_name=${encodeURIComponent(SITE_NAME)}&page_key=${encodeURIComponent(page.key)}&limit=1`
            );
            if (commentRes.ok) {
              const commentData = await commentRes.json();
              page.comment_count = commentData.count || 0;
            } else {
              page.comment_count = 0;
            }
          } catch (e) {
            page.comment_count = 0;
          }
        }));

        // è®¡ç®—æ€»è®¡
        let totalPV = 0;
        let totalComments = 0;

        pages.forEach(page => {
          totalPV += page.pv || 0;
          totalComments += page.comment_count || 0;
        });

        // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
        document.getElementById('total-pv').textContent = totalPV.toLocaleString();
        document.getElementById('total-posts').textContent = pages.length.toLocaleString();
        document.getElementById('total-comments').textContent = totalComments.toLocaleString();

        // æŒ‰æµè§ˆé‡æ’åº
        pages.sort((a, b) => (b.pv || 0) - (a.pv || 0));

        // ç”Ÿæˆè¡¨æ ¼
        const tbody = document.getElementById('stats-tbody');
        tbody.innerHTML = '';

        pages.slice(0, 20).forEach((page, index) => {
          const row = document.createElement('tr');

          // æ’å
          const rankCell = document.createElement('td');
          rankCell.className = 'font-bold';
          if (index === 0) {
            rankCell.innerHTML = 'ğŸ¥‡';
          } else if (index === 1) {
            rankCell.innerHTML = 'ğŸ¥ˆ';
          } else if (index === 2) {
            rankCell.innerHTML = 'ğŸ¥‰';
          } else {
            rankCell.textContent = index + 1;
          }
          row.appendChild(rankCell);

          // æ ‡é¢˜ï¼ˆå¸¦é“¾æ¥ï¼‰
          const titleCell = document.createElement('td');
          const link = document.createElement('a');
          link.href = page.key;
          link.textContent = page.title || page.key;
          link.className = 'link link-hover';
          link.target = '_blank';
          titleCell.appendChild(link);
          row.appendChild(titleCell);

          // æµè§ˆé‡
          const pvCell = document.createElement('td');
          pvCell.className = 'text-right font-semibold';
          pvCell.textContent = (page.pv || 0).toLocaleString();
          row.appendChild(pvCell);

          // è¯„è®ºæ•°
          const commentCell = document.createElement('td');
          commentCell.className = 'text-right';
          commentCell.textContent = (page.comment_count || 0).toLocaleString();
          row.appendChild(commentCell);

          tbody.appendChild(row);
        });

        loading.classList.add('hidden');
        statsTable.classList.remove('hidden');

      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        loading.classList.add('hidden');
        errorContainer.classList.remove('hidden');
        document.getElementById('error-text').textContent = `åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`;
      }
    }

    // äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', () => {
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      if (checkAuth()) {
        showStats();
      } else {
        showLogin();
      }

      // ç™»å½•æŒ‰é’®
      document.getElementById('login-btn').addEventListener('click', handleLogin);

      // å¯†ç è¾“å…¥æ¡†å›è½¦
      const inputs = ['password-input', 'artalk-name-input', 'artalk-email-input', 'artalk-password-input'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleLogin();
          }
        });
      });

      // é€€å‡ºç™»å½•æŒ‰é’®
      document.getElementById('logout-btn').addEventListener('click', () => {
        clearAuth();
        showLogin();
      });

      // åˆ·æ–°æŒ‰é’®
      document.getElementById('refresh-btn').addEventListener('click', () => {
        loadStats();
      });
    });
  </script>
</BaseLayout>
