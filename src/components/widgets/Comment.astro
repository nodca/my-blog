---
// Artalk 评论组件
---

<div id="artalk" class="mt-8 pt-8 border-t border-base-300"></div>

<link href="https://unpkg.com/artalk/dist/Artalk.css" rel="stylesheet" />
<script is:inline src="https://unpkg.com/artalk/dist/Artalk.js"></script>

<style is:global>
  /* 邮箱提示样式 */
  .email-hint {
    font-size: 12px;
    color: #888;
    margin-left: 4px;
  }
</style>

<script is:inline>
  function initArtalk() {
    // 清除之前的实例
    var container = document.querySelector('#artalk');
    if (!container) return;
    container.innerHTML = '';

    var artalk = Artalk.init({
      el: '#artalk',
      server: 'https://comment.cyb1.org',
      site: 'nodca的博客',
      pageKey: window.location.pathname,
      darkMode: document.documentElement.getAttribute('data-theme') === 'dracula',
      placeholder: '欢迎留言~',
    });

    // 增强版：在邮箱标签旁添加提示
    function addEmailHint() {
      var hintText = '(不会公开)';
      
      // 查找所有可能的邮箱输入框
      var inputs = document.querySelectorAll('.atk-wrap input[name="email"], .atk-wrap input[type="email"]');
      
      inputs.forEach(function(input) {
        // 策略 1: 直接修改 Placeholder (最稳妥，且兼容无 label 的情况)
        if (input.placeholder && !input.placeholder.includes(hintText)) {
            input.placeholder = input.placeholder + ' ' + hintText;
        }

        // 策略 2: 尝试在 Label 旁添加文字 (保留之前的逻辑作为补充)
        // 找到包含 input 的容器
        var item = input.closest('.atk-item') || input.parentElement;
        if (!item) return;

        var labels = item.querySelectorAll('.atk-label, label');
        labels.forEach(function(label) {
           // 检查内容是否相关
           var text = label.textContent.trim().toLowerCase();
           if ((text === '邮箱' || text === 'email' || text.includes('邮箱')) && !text.includes(hintText)) {
             // 检查是否已添加 span
             if (label.nextElementSibling && label.nextElementSibling.classList.contains('email-hint')) return;
             
             var hint = document.createElement('span');
             hint.className = 'email-hint';
             hint.textContent = hintText;
             label.insertAdjacentElement('afterend', hint);
           }
        });
      });
    }

    // 使用 MutationObserver 监听 DOM 变化，确保 Artalk 渲染完成后立即执行
    var observer = new MutationObserver(function(mutations) {
      addEmailHint();
    });

    observer.observe(container, { childList: true, subtree: true });
  }

  // 初始加载
  document.addEventListener('DOMContentLoaded', initArtalk);

  // Astro 页面切换后重新初始化
  document.addEventListener('astro:page-load', initArtalk);
  document.addEventListener('astro:after-swap', initArtalk);
</script>
