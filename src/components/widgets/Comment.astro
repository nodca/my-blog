---
// Artalk 评论组件
---

<div id="artalk" class="mt-8 pt-8 border-t border-base-300"></div>

<style is:global>
  /* 邮箱提示样式 */
  .email-hint {
    font-size: 12px;
    color: #888;
    margin-left: 4px;
  }
</style>

<script is:inline>
  function loadArtalk() {
    var container = document.querySelector('#artalk');
    if (!container || container.dataset.loaded) return;

    // 标记已开始加载，防止重复执行
    container.dataset.loaded = 'true';

    // 定义资源 URL (使用国内镜像)
    var cssUrl = 'https://registry.npmmirror.com/artalk/2.9.1/files/dist/Artalk.css';
    var jsUrl = 'https://registry.npmmirror.com/artalk/2.9.1/files/dist/Artalk.js';

    // 动态加载 CSS
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = cssUrl;
    document.head.appendChild(link);

    // 动态加载 JS
    var script = document.createElement('script');
    script.src = jsUrl;
    script.onload = initArtalkInstance;
    document.body.appendChild(script);
  }

  function initArtalkInstance() {
    var container = document.querySelector('#artalk');
    if (!container) return;
    container.innerHTML = '';

    var artalk = Artalk.init({
      el: '#artalk',
      server: 'https://comment.cyb1.org',
      site: 'nodca的博客',
      pageKey: window.location.pathname,
      darkMode: document.documentElement.getAttribute('data-theme') === 'dracula',
      placeholder: '欢迎留言~',
      useBackendConf: false,
      gravatar: {
        mirror: 'https://cravatar.cn/avatar/',
        params: 'd=monsterid'
      }
    });

    // 增强版：在邮箱标签旁添加提示
    function addEmailHint() {
      var hintText = '(不会公开)';
      var container = document.querySelector('#artalk');
      if (!container) return;

      // 1. 找输入框，修改 Placeholder
      var inputs = container.querySelectorAll('input[name="email"], input[type="email"]');
      inputs.forEach(function(input) {
        if (input.placeholder && input.placeholder.indexOf(hintText) === -1) {
            input.placeholder = input.placeholder + ' ' + hintText;
        }
      });

      // 2. 找 Label，添加可见文字
      // Artalk 的 Label 通常在 .atk-header-input .atk-item .atk-label 或者是 placeholder 表现
      // 我们尝试遍历所有包含“邮箱”字的元素
      var elements = container.getElementsByTagName('*');
      for (var i = 0; i < elements.length; i++) {
        var el = elements[i];
        // 排除 script, style 和我们自己加的 hint
        if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE' || el.classList.contains('email-hint')) continue;
        
        // 检查文本内容 (只有当它是叶子节点或只包含文本时)
        if (el.children.length === 0 && el.textContent) {
           var text = el.textContent.trim().toLowerCase();
           if (text === '邮箱' || text === 'email') {
             // 找到了“邮箱”两个字，检查旁边有没有提示
             // 这种通常是 Label
             if (el.nextElementSibling && el.nextElementSibling.classList.contains('email-hint')) continue;
             
             // 如果父级已经是 hint 了，跳过
             if (el.parentElement.classList.contains('email-hint')) continue;

             var hint = document.createElement('span');
             hint.className = 'email-hint';
             hint.textContent = hintText;
             hint.style.color = '#ff6b6b'; // 显眼颜色
             hint.style.fontSize = '0.8em';
             hint.style.marginLeft = '5px';
             
             // 插入到该元素后面
             el.insertAdjacentElement('afterend', hint);
           }
        }
      }
    }

    // 暴力轮询：每 500ms 执行一次，持续 10 秒
    // 这是为了应对 Artalk 可能的异步渲染或重绘
    var checkCount = 0;
    var interval = setInterval(function() {
      addEmailHint();
      checkCount++;
      if (checkCount > 20) clearInterval(interval);
    }, 500);

    var observer = new MutationObserver(function(mutations) {
      addEmailHint();
    });
    observer.observe(container, { childList: true, subtree: true });
  }

  function setupLazyLoad() {
    var container = document.querySelector('#artalk');
    if (!container) return;

    // 重置加载状态 (用于 Astro 页面切换)
    delete container.dataset.loaded;

    // 策略优化：不再等待滚动，而是延迟加载 (Idle Load)
    // 这样既不阻塞首屏，又能保证用户滚下来时通常已经加载好了
    var loadDelay = 2000; // 2秒后加载
    
    if ('requestIdleCallback' in window) {
      window.requestIdleCallback(function() {
        setTimeout(loadArtalk, loadDelay);
      });
    } else {
      setTimeout(loadArtalk, loadDelay + 1000);
    }
  }

  // 初始加载
  document.addEventListener('DOMContentLoaded', setupLazyLoad);

  // Astro 页面切换后重新初始化
  document.addEventListener('astro:page-load', setupLazyLoad);
  document.addEventListener('astro:after-swap', setupLazyLoad);
</script>
